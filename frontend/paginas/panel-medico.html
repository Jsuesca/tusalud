<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del M√©dico | Tu Salud a un Clic</title>

  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/panel-medico.css">
</head>

<body class="panel-body">
  <div class="panel-medico">
    <h1>Bienvenido, <span id="nombreMedico">M√©dico</span></h1>

    <div class="foto-container" style="text-align:center; margin-bottom: 20px;">
      <img id="fotoMedico" 
           src="../img/LogosPrincipales/doctor.png" 
           alt="Foto del m√©dico" 
           style="width:130px; height:130px; border-radius:50%; object-fit:cover; border:2px solid #ccc;">
    </div>

    <div class="info-personal">
      <h2>Informaci√≥n Personal</h2>
      <p><strong>Especialidad:</strong> <span id="especialidad"></span></p>
      <p><strong>Correo:</strong> <span id="correo"></span></p>
      <p><strong>Tel√©fono:</strong> <span id="telefono"></span></p>
      <p><strong>Horario:</strong> <span id="horario"></span></p>
    </div>

    <div class="acciones">
      <button id="editarPerfil">‚úèÔ∏è Editar Perfil</button>
      <button id="irPrincipal">üè† Ir a P√°gina Principal</button>
      <button id="cerrarSesion">üö™ Cerrar Sesi√≥n</button>
    </div>

    <div class="citas">
      <h2>Citas Asignadas</h2>
      <div id="listaCitas">
        <p>Cargando citas...</p>
      </div>
    </div>
  </div>

  <script>
    const medicoLogueado = JSON.parse(localStorage.getItem("medicoLogueado"));
    const token = localStorage.getItem("tokenMedico");

    if (!medicoLogueado || !token) {
      alert("‚ö†Ô∏è Debes iniciar sesi√≥n como m√©dico para acceder a este panel.");
      window.location.href = "medico-login.html";
    } else {
      document.getElementById("nombreMedico").textContent = medicoLogueado.nombre;
      document.getElementById("especialidad").textContent = medicoLogueado.especialidad;
      document.getElementById("correo").textContent = medicoLogueado.correo;
      document.getElementById("telefono").textContent = medicoLogueado.telefono;
      document.getElementById("horario").textContent = medicoLogueado.horario;

      const foto = medicoLogueado.foto || "../img/LogosPrincipales/doctor.png";
      document.getElementById("fotoMedico").src = foto;
    }

    // =============================
    // CARGAR CITAS DEL M√âDICO
    // =============================
    async function cargarCitas() {
      try {
        const response = await fetch(`http://localhost:5000/api/citas?medicoId=${medicoLogueado._id}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) throw new Error("Error al obtener las citas");

        const citas = await response.json();
        const lista = document.getElementById("listaCitas");
        lista.innerHTML = "";

        if (citas.length === 0) {
          lista.innerHTML = "<p>No tienes citas agendadas por ahora.</p>";
          return;
        }

        citas.forEach(cita => {
          const div = document.createElement("div");
          div.classList.add("cita");
          div.innerHTML = `
            <p><strong>Paciente:</strong> ${cita.pacienteNombre}</p>
            <p><strong>Fecha:</strong> ${new Date(cita.fecha).toLocaleDateString()}</p>
            <p><strong>Hora:</strong> ${cita.hora}</p>
            <p><strong>Motivo:</strong> ${cita.motivo}</p>
            <button class="eliminar-cita" data-id="${cita._id}" style="
              background-color: #dc3545;
              color: white;
              border: none;
              padding: 8px 14px;
              border-radius: 6px;
              cursor: pointer;
              margin-top: 10px;
            ">üóëÔ∏è Eliminar Cita</button>
            <hr>
          `;
          lista.appendChild(div);
        });

        // ‚úÖ Activar bot√≥n de eliminaci√≥n
        document.querySelectorAll(".eliminar-cita").forEach(boton => {
          boton.addEventListener("click", async (e) => {
            const idCita = e.target.getAttribute("data-id");
            const confirmar = confirm("¬øSeguro que deseas eliminar esta cita?");
            if (!confirmar) return;

            try {
              const res = await fetch(`http://localhost:5000/api/citas/${idCita}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
              });

              if (!res.ok) throw new Error("Error al eliminar la cita");
              alert("‚úÖ Cita eliminada correctamente.");
              cargarCitas(); // recarga lista
            } catch (err) {
              alert("‚ùå No se pudo eliminar la cita.");
              console.error(err);
            }
          });
        });

      } catch (error) {
        console.error("‚ùå Error al cargar las citas:", error);
        document.getElementById("listaCitas").innerHTML = "<p>Error al cargar citas.</p>";
      }
    }

    cargarCitas();

    // =============================
    // BOTONES DEL PANEL
    // =============================
    document.getElementById("editarPerfil").addEventListener("click", () => {
      window.location.href = "editar-perfil-medico.html";
    });

    document.getElementById("irPrincipal").addEventListener("click", () => {
      window.location.href = "../index.html";
    });

    document.getElementById("cerrarSesion").addEventListener("click", () => {
      localStorage.removeItem("medicoLogueado");
      localStorage.removeItem("tokenMedico");
      localStorage.removeItem("medicoId");
      alert("Sesi√≥n cerrada correctamente.");
      window.location.href = "../index.html";
    });
  </script>
</body>
</html>
